{% extends 'base.html' %}

{% block title %}{% if article %}Editar{% else %}Criar{% endif %} Artigo{% endblock %}

{% block content %}
<div class="modern-post-container">
    <div class="modern-post-card">
        <div class="modern-post-header">
            <div class="author-profile">
                <div class="author-avatar-large" {% if user.profile.avatar %}style="background-image: url('{{ user.profile.avatar.url }}'); background-size: cover; font-size: 0;"{% endif %}>
                    {{ user.username|slice:":1"|upper }}
                </div>
                <div class="author-info-large">
                    <h3 class="author-username">{{ user.username }}</h3>
                    <span class="author-role">
                        {% if user.profile.role == 'jornalista' %}Jornalista{% elif user.profile.role == 'admin' %}Administrador{% else %}Leitor{% endif %}
                    </span>
                </div>
            </div>
        </div>
        
        <form method="post" enctype="multipart/form-data" class="modern-post-form">
            {% csrf_token %}
            
            <div class="post-input-group">
                <input type="text" name="title" id="id_title" value="{% if article %}{{ article.title }}{% endif %}" class="post-title-input" required placeholder="T√≠tulo da not√≠cia..." autofocus>
            </div>
            
            <div class="post-input-group">
                <textarea name="content" id="id_content" rows="8" class="post-content-input" required placeholder="O que est√° acontecendo na sua regi√£o?">{% if article %}{{ article.content }}{% endif %}</textarea>
            </div>
            
            <div class="post-expandable-section" id="expandableSection" style="display: none;">
                <div class="post-input-group">
                    <label for="id_excerpt" class="post-label">Resumo (opcional)</label>
                    <textarea name="excerpt" id="id_excerpt" rows="2" class="post-excerpt-input" placeholder="Breve resumo que aparecer√° nos cards...">{% if article %}{{ article.excerpt }}{% endif %}</textarea>
                </div>
                
                <div class="post-input-group">
                    <label for="id_tags" class="post-label">Tags</label>
                    <input type="text" name="tags" id="id_tags" value="{% if article %}{% for tag in article.tags.all %}{{ tag.name }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}" class="post-tags-input" placeholder="pol√≠tica, esportes, tecnologia...">
                </div>
                
                <div class="post-input-group">
                    <label for="id_location_name" class="post-label">Localiza√ß√£o</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" name="location_name" id="id_location_name" value="{% if article %}{{ article.location_name }}{% endif %}" class="post-location-input" placeholder="S√£o Paulo, Zona Leste" style="flex: 1;">
                        <button type="button" id="getLocationBtn" class="action-icon-btn" style="padding: 0.5rem 1rem; background: var(--primary-purple); color: white; border-radius: 0.5rem; font-size: 0.875rem; white-space: nowrap;" title="Usar minha localiza√ß√£o atual">
                            üìç Usar Localiza√ß√£o
                        </button>
                    </div>
                    <div id="locationStatus" style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--text-secondary);"></div>
                </div>
                
                <div class="post-location-coords">
                    <input type="number" step="any" name="latitude" id="id_latitude" value="{% if article %}{{ article.latitude }}{% endif %}" class="post-coord-input" placeholder="Latitude" readonly>
                    <input type="number" step="any" name="longitude" id="id_longitude" value="{% if article %}{{ article.longitude }}{% endif %}" class="post-coord-input" placeholder="Longitude" readonly>
                </div>
                
                <div class="post-options">
                    <label class="post-checkbox-label">
                        <input type="checkbox" name="published" id="id_published" {% if article.published %}checked{% endif %} class="post-checkbox">
                        <span>Publicar imediatamente</span>
                    </label>
                    
                    {% if user.profile.role == 'admin' %}
                        <label class="post-checkbox-label">
                            <input type="checkbox" name="featured" id="id_featured" {% if article.featured %}checked{% endif %} class="post-checkbox">
                            <span>Destacar na p√°gina inicial</span>
                        </label>
                    {% endif %}
                </div>
            </div>
            
            <input type="file" name="image" id="id_image" class="hidden-file-input" accept="image/*">
            
            <div class="post-actions-bar">
                <div class="post-action-icons">
                    <button type="button" class="action-icon-btn" onclick="document.getElementById('id_image').click()" title="Adicionar imagem">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </button>
                    
                    <button type="button" class="action-icon-btn" onclick="document.getElementById('expandableSection').style.display = document.getElementById('expandableSection').style.display === 'none' ? 'block' : 'none'" title="Mais op√ß√µes">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                    </button>
                    
                    <span class="image-filename" id="imageFilename"></span>
                </div>
                
                <button type="submit" class="post-publish-btn">Publicar</button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('id_image').addEventListener('change', function(e) {
    const filename = e.target.files[0]?.name;
    const filenameSpan = document.getElementById('imageFilename');
    if (filename) {
        filenameSpan.textContent = filename;
        filenameSpan.style.display = 'inline';
    } else {
        filenameSpan.style.display = 'none';
    }
});

document.getElementById('getLocationBtn').addEventListener('click', function() {
    const statusDiv = document.getElementById('locationStatus');
    const btn = this;
    
    if (!navigator.geolocation) {
        statusDiv.textContent = '‚ùå Geolocaliza√ß√£o n√£o suportada pelo navegador';
        statusDiv.style.color = '#e74c3c';
        return;
    }
    
    btn.disabled = true;
    btn.textContent = '‚è≥ Buscando...';
    statusDiv.textContent = 'üîç Obtendo sua localiza√ß√£o...';
    statusDiv.style.color = '#3498db';
    
    navigator.geolocation.getCurrentPosition(
        async function(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            document.getElementById('id_latitude').value = lat.toFixed(6);
            document.getElementById('id_longitude').value = lon.toFixed(6);
            
            statusDiv.textContent = 'üåç Buscando nome do local...';
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'ConectaZL/1.0'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const address = data.address;
                    
                    let locationName = '';
                    if (address.suburb || address.neighbourhood) {
                        locationName = address.suburb || address.neighbourhood;
                    }
                    if (address.city || address.town || address.municipality) {
                        const city = address.city || address.town || address.municipality;
                        locationName = locationName ? `${locationName}, ${city}` : city;
                    }
                    if (address.state) {
                        locationName = locationName ? `${locationName}, ${address.state}` : address.state;
                    }
                    
                    if (!locationName && data.display_name) {
                        const parts = data.display_name.split(',');
                        locationName = parts.slice(0, 3).join(',');
                    }
                    
                    document.getElementById('id_location_name').value = locationName || 'Local n√£o identificado';
                    statusDiv.textContent = '‚úÖ Localiza√ß√£o capturada com sucesso!';
                    statusDiv.style.color = '#27ae60';
                } else {
                    throw new Error('Erro ao buscar endere√ßo');
                }
            } catch (error) {
                console.error('Erro ao buscar nome do local:', error);
                statusDiv.textContent = '‚ö†Ô∏è Coordenadas capturadas, mas n√£o foi poss√≠vel identificar o local';
                statusDiv.style.color = '#f39c12';
            }
            
            btn.disabled = false;
            btn.textContent = 'üìç Usar Localiza√ß√£o';
        },
        function(error) {
            let errorMessage = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = '‚ùå Permiss√£o negada. Habilite a localiza√ß√£o no navegador.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = '‚ùå Localiza√ß√£o indispon√≠vel no momento.';
                    break;
                case error.TIMEOUT:
                    errorMessage = '‚ùå Tempo esgotado ao buscar localiza√ß√£o.';
                    break;
                default:
                    errorMessage = '‚ùå Erro ao obter localiza√ß√£o.';
            }
            statusDiv.textContent = errorMessage;
            statusDiv.style.color = '#e74c3c';
            btn.disabled = false;
            btn.textContent = 'üìç Usar Localiza√ß√£o';
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
});
</script>
{% endblock %}
